---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { getCollection } from 'astro:content';

// Fetch all blog posts
const allPosts = await getCollection('blog');

// Extract category from the post ID (folder name)
function getCategory(id: string): string {
  const parts = id.split('/');
  if (parts.length > 1) {
    // Capitalise first letter
    return parts[0].charAt(0).toUpperCase() + parts[0].slice(1);
  }
  return 'General';
}

// Get slug from post ID (just the filename without folder)
function getSlug(id: string): string {
  const parts = id.split('/');
  return parts[parts.length - 1];
}

// Calculate read time
function calculateReadTime(content: string): string {
  const wordsPerMinute = 200;
  const words = content.split(/\s+/).length;
  const minutes = Math.ceil(words / wordsPerMinute);
  return `${minutes} min read`;
}

// Sort by date, newest first
const sortedPosts = allPosts.sort((a, b) => {
  const dateA = new Date(a.data.publishedDate).getTime();
  const dateB = new Date(b.data.publishedDate).getTime();
  return dateB - dateA;
});

// Map to our display format
const posts = sortedPosts.map((post) => ({
  slug: getSlug(post.id),
  title: post.data.title,
  excerpt: post.data.excerpt,
  category: getCategory(post.id),
  date: post.data.publishedDate,
  readTime: calculateReadTime(post.body || ''),
  featured: post.data.featured,
}));

const categories = ['All', 'Security', 'Performance', 'Maintenance', 'Hosting', 'Compliance'];

function formatDate(dateStr: string) {
  return new Date(dateStr).toLocaleDateString('en-IE', {
    day: 'numeric',
    month: 'short',
    year: 'numeric',
  });
}

// Category colors
const categoryColors: Record<string, { bg: string; text: string }> = {
  Security: { bg: 'rgba(244, 54, 84, 0.15)', text: '#F43654' },
  Performance: { bg: 'rgba(59, 130, 246, 0.15)', text: '#3B82F6' },
  Maintenance: { bg: 'rgba(244, 140, 84, 0.15)', text: '#F48C54' },
  Hosting: { bg: 'rgba(34, 197, 94, 0.15)', text: '#22C55E' },
  Compliance: { bg: 'rgba(168, 85, 247, 0.15)', text: '#A855F7' },
};
---

<Layout
  title="Blog | SparkHost.ie - WordPress Hosting & Maintenance Tips"
  description="Practical WordPress tips for Irish businesses. Security, performance, maintenance, and hosting advice you can actually use."
>
  <Header currentPath="/blog" />

  <main>
    <!-- Hero Section -->
    <section class="pt-32 pb-12">
      <div class="container">
        <div class="text-center max-w-2xl mx-auto" data-animate="fade-up">
          <span class="inline-block text-[var(--color-spark-orange)] text-sm font-semibold tracking-wider uppercase mb-4">Blog</span>
          <h1 class="text-4xl md:text-5xl font-bold mb-6" style="font-family: var(--font-display);">
            WordPress <span class="text-gradient-spark">Insights</span>
          </h1>
          <p class="text-xl text-white/60">
            Practical tips for Irish businesses. No fluff, just actionable advice.
          </p>
        </div>
      </div>
    </section>

    <!-- Category Filter -->
    <section class="pb-10">
      <div class="container">
        <div class="container-narrow mx-auto">
          <div class="flex flex-wrap justify-center gap-2">
            {categories.map((cat, i) => (
              <button
                class={`px-4 py-2 rounded-full text-sm font-medium transition-all ${i === 0 ? 'bg-gradient-to-r from-[var(--color-spark-red)] to-[var(--color-spark-orange)] text-white' : 'bg-white/5 border border-white/10 text-white/70 hover:text-white hover:border-[var(--color-spark-orange)]/50'}`}
                data-category={cat.toLowerCase()}
              >
                {cat}
              </button>
            ))}
          </div>
        </div>
      </div>
    </section>

    <!-- Blog Posts Grid -->
    <section class="pb-16">
      <div class="container">
        <div class="grid md:grid-cols-2 gap-6" data-animate-stagger>
          {posts.map(post => {
            const catStyle = categoryColors[post.category] || categoryColors.Security;
            return (
              <article class="card-glass card-shine overflow-hidden group" data-category={post.category.toLowerCase()}>
                <a href={`/blog/${post.slug}`} class="block p-6">
                  <div class="flex items-center gap-3 mb-4">
                    <span
                      class="px-3 py-1 rounded-full text-xs font-semibold uppercase tracking-wider"
                      style={`background: ${catStyle.bg}; color: ${catStyle.text};`}
                    >
                      {post.category}
                    </span>
                    <span class="text-xs text-white/40">{formatDate(post.date)}</span>
                    <span class="text-xs text-white/40">{post.readTime}</span>
                  </div>
                  <h2 class="text-xl font-bold mb-3 group-hover:text-[var(--color-spark-orange)] transition-colors" style="font-family: var(--font-display);">
                    {post.title}
                  </h2>
                  <p class="text-white/60 text-sm leading-relaxed mb-4">
                    {post.excerpt}
                  </p>
                  <span class="inline-flex items-center gap-2 text-[var(--color-spark-orange)] text-sm font-medium group-hover:gap-3 transition-all">
                    Read more
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
                    </svg>
                  </span>
                </a>
              </article>
            );
          })}
        </div>
      </div>
    </section>

    <!-- Newsletter CTA -->
    <section class="py-16">
      <div class="container">
        <div class="text-center">
          <h2 class="text-2xl md:text-3xl font-bold mb-4" style="font-family: var(--font-display);">
            Get WordPress Tips in Your Inbox
          </h2>
          <p class="text-lg text-white/60 mb-8 max-w-lg mx-auto">
            Occasional updates on WordPress security, performance, and maintenance. No spam.
          </p>
          <form class="flex flex-col sm:flex-row gap-3 max-w-md mx-auto">
            <input
              type="email"
              placeholder="your@email.ie"
              class="flex-1 px-4 py-3 rounded-full bg-white/5 border border-white/10 text-white placeholder-white/40 focus:border-[var(--color-spark-orange)] focus:outline-none transition-colors"
            />
            <button type="submit" class="btn-spark">
              <span>Subscribe</span>
            </button>
          </form>
        </div>
      </div>
    </section>
  </main>

  <Footer />
</Layout>

<script>
  // Simple category filter (client-side)
  const buttons = document.querySelectorAll('[data-category]') as NodeListOf<HTMLButtonElement>;
  const articles = document.querySelectorAll('article[data-category]') as NodeListOf<HTMLElement>;

  // After initial animation, mark all articles as "no-animate" so filtering doesn't cause opacity issues
  setTimeout(() => {
    articles.forEach(article => {
      article.classList.add('no-animate');
    });
  }, 1500); // Wait for all staggered animations to complete

  buttons.forEach(btn => {
    btn.addEventListener('click', () => {
      const category = btn.dataset.category;

      // Update button styles
      buttons.forEach(b => {
        if (b === btn) {
          b.className = 'px-4 py-2 rounded-full text-sm font-medium transition-all bg-gradient-to-r from-[var(--color-spark-red)] to-[var(--color-spark-orange)] text-white';
        } else {
          b.className = 'px-4 py-2 rounded-full text-sm font-medium transition-all bg-white/5 border border-white/10 text-white/70 hover:text-white hover:border-[var(--color-spark-orange)]/50';
        }
      });

      // Filter articles - ensure they're visible and not stuck at opacity 0
      articles.forEach(article => {
        // Make sure animations don't interfere with filtering
        article.classList.add('no-animate');

        if (category === 'all' || article.dataset.category === category) {
          article.style.display = 'block';
          article.style.opacity = '1';
        } else {
          article.style.display = 'none';
        }
      });
    });
  });
</script>
